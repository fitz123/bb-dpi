#!/bin/bash
# xray-users - Manage XRay VLESS REALITY users
# Usage: xray-users <command> [args]

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="$(dirname "$SCRIPT_DIR")"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Load configuration
load_config() {
    if [[ -f "$REPO_DIR/.env" ]]; then
        source "$REPO_DIR/.env"
    else
        echo -e "${RED}Error: .env not found. Run deploy.sh first.${NC}"
        exit 1
    fi

    USERS_FILE="$REPO_DIR/users.json"
}

# Initialize users file if it doesn't exist
init_users_file() {
    if [[ ! -f "$USERS_FILE" ]]; then
        echo '{}' > "$USERS_FILE"
    fi
}

# Get server config
get_server_config() {
    ssh "$SSH_HOST" "cat $CONFIG_PATH" 2>/dev/null
}

# Update server config
update_server_config() {
    local config="$1"
    echo "$config" | ssh "$SSH_HOST" "cat > $CONFIG_PATH"
}

# Restart XRay container
restart_xray() {
    ssh "$SSH_HOST" "cd /opt/xray && docker compose restart" &>/dev/null &
    sleep 3
}

# Get all UUIDs from server
get_server_uuids() {
    get_server_config | jq -r '.inbounds[0].settings.clients[].id'
}

# Get user name by UUID
get_user_name() {
    local uuid="$1"
    jq -r --arg uuid "$uuid" '.[$uuid] // "unnamed"' "$USERS_FILE"
}

# Set user name
set_user_name() {
    local uuid="$1"
    local name="$2"
    local tmp
    tmp=$(mktemp)
    jq --arg uuid "$uuid" --arg name "$name" '.[$uuid] = $name' "$USERS_FILE" > "$tmp"
    mv "$tmp" "$USERS_FILE"
}

# Remove user name
remove_user_name() {
    local uuid="$1"
    local tmp
    tmp=$(mktemp)
    jq --arg uuid "$uuid" 'del(.[$uuid])' "$USERS_FILE" > "$tmp"
    mv "$tmp" "$USERS_FILE"
}

# Find UUID by name
find_uuid_by_name() {
    local name="$1"
    jq -r --arg name "$name" 'to_entries[] | select(.value == $name) | .key' "$USERS_FILE" | head -1
}

# Resolve UUID (accepts UUID or name)
resolve_uuid() {
    local input="$1"
    if [[ "$input" =~ ^[0-9a-fA-F-]{36}$ ]]; then
        echo "$input"
    else
        find_uuid_by_name "$input"
    fi
}

# Generate VLESS share URL
generate_url() {
    local uuid="$1"
    local name="${2:-$(get_user_name "$uuid")}"
    local encoded_name
    encoded_name=$(echo -n "$name" | jq -sRr @uri)

    echo "vless://${uuid}@${SERVER}:${PORT}?encryption=none&flow=${FLOW}&security=reality&sni=${SNI}&fp=${FINGERPRINT}&pbk=${PUBLIC_KEY}&sid=${SHORT_ID}&type=tcp#${encoded_name}"
}

# Command: list
cmd_list() {
    init_users_file
    echo -e "${BLUE}XRay VLESS Users:${NC}"
    echo "─────────────────────────────────────────────────────"

    local uuids count=0
    uuids=$(get_server_uuids)

    while IFS= read -r uuid; do
        [[ -z "$uuid" ]] && continue
        local name
        name=$(get_user_name "$uuid")
        count=$((count + 1))
        printf "${GREEN}%d.${NC} %-20s ${YELLOW}%s${NC}\n" "$count" "$name" "$uuid"
    done <<< "$uuids"

    echo "─────────────────────────────────────────────────────"
    echo -e "Total: ${GREEN}$count${NC} users"
}

# Command: add
cmd_add() {
    local name="${1:-}"

    if [[ -z "$name" ]]; then
        echo -e "${RED}Error: Name required${NC}"
        echo "Usage: xray-users add <name>"
        exit 1
    fi

    init_users_file

    local uuid
    uuid=$(uuidgen | tr '[:upper:]' '[:lower:]')

    echo -e "${BLUE}Adding new user: ${GREEN}$name${NC}"
    echo -e "UUID: ${YELLOW}$uuid${NC}"

    local config new_config
    config=$(get_server_config)
    new_config=$(echo "$config" | jq --arg uuid "$uuid" --arg flow "$FLOW" \
        '.inbounds[0].settings.clients += [{"id": $uuid, "flow": $flow}]')

    echo -n "Updating server config... "
    update_server_config "$new_config"
    echo -e "${GREEN}done${NC}"

    echo -n "Restarting XRay... "
    restart_xray
    echo -e "${GREEN}done${NC}"

    set_user_name "$uuid" "$name"

    echo ""
    echo -e "${GREEN}Share URL:${NC}"
    generate_url "$uuid" "$name"
    echo ""
}

# Command: remove
cmd_remove() {
    local input="${1:-}"

    if [[ -z "$input" ]]; then
        echo -e "${RED}Error: UUID or name required${NC}"
        echo "Usage: xray-users remove <uuid|name>"
        exit 1
    fi

    init_users_file

    local uuid
    uuid=$(resolve_uuid "$input")

    if [[ -z "$uuid" ]]; then
        echo -e "${RED}Error: User not found: $input${NC}"
        exit 1
    fi

    local name
    name=$(get_user_name "$uuid")

    echo -e "${YELLOW}Removing user: $name ($uuid)${NC}"
    read -p "Are you sure? [y/N] " confirm

    if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
        echo "Cancelled."
        exit 0
    fi

    local config new_config
    config=$(get_server_config)
    new_config=$(echo "$config" | jq --arg uuid "$uuid" \
        '.inbounds[0].settings.clients |= map(select(.id != $uuid))')

    echo -n "Updating server config... "
    update_server_config "$new_config"
    echo -e "${GREEN}done${NC}"

    echo -n "Restarting XRay... "
    restart_xray
    echo -e "${GREEN}done${NC}"

    remove_user_name "$uuid"

    echo -e "${GREEN}User removed successfully${NC}"
}

# Command: url
cmd_url() {
    local input="${1:-}"

    if [[ -z "$input" ]]; then
        echo -e "${RED}Error: UUID or name required${NC}"
        echo "Usage: xray-users url <uuid|name>"
        exit 1
    fi

    init_users_file

    local uuid
    uuid=$(resolve_uuid "$input")

    if [[ -z "$uuid" ]]; then
        echo -e "${RED}Error: User not found: $input${NC}"
        exit 1
    fi

    generate_url "$uuid"
}

# Command: sync
cmd_sync() {
    init_users_file

    echo -e "${BLUE}Syncing with server...${NC}"

    local uuids count=0
    uuids=$(get_server_uuids)

    while IFS= read -r uuid; do
        [[ -z "$uuid" ]] && continue
        local name
        name=$(get_user_name "$uuid")

        if [[ "$name" == "unnamed" ]]; then
            echo -e "${YELLOW}Found unnamed user: $uuid${NC}"
            read -p "Enter name for this user (or press Enter to skip): " new_name
            if [[ -n "$new_name" ]]; then
                set_user_name "$uuid" "$new_name"
                echo -e "  Set name: ${GREEN}$new_name${NC}"
            fi
        fi
        count=$((count + 1))
    done <<< "$uuids"

    echo -e "${GREEN}Sync complete. $count users on server.${NC}"
}

# Command: help
cmd_help() {
    echo "xray-users - Manage XRay VLESS REALITY users"
    echo ""
    echo "Usage: xray-users <command> [args]"
    echo ""
    echo "Commands:"
    echo "  list              List all users"
    echo "  add <name>        Add new user and show share URL"
    echo "  remove <id|name>  Remove user by UUID or name"
    echo "  url <id|name>     Generate share URL for user"
    echo "  sync              Sync local names with server"
    echo "  help              Show this help"
    echo ""
    echo "Examples:"
    echo "  xray-users add \"Mom iPhone\""
    echo "  xray-users url \"Mom iPhone\""
    echo "  xray-users remove \"Mom iPhone\""
}

# Main
main() {
    load_config

    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        list)   cmd_list "$@" ;;
        add)    cmd_add "$@" ;;
        remove) cmd_remove "$@" ;;
        url)    cmd_url "$@" ;;
        sync)   cmd_sync "$@" ;;
        help|--help|-h) cmd_help ;;
        *)
            echo -e "${RED}Unknown command: $cmd${NC}"
            cmd_help
            exit 1
            ;;
    esac
}

main "$@"

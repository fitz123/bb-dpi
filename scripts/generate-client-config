#!/bin/bash
#
# Generate sing-box client config and package from VLESS URL or user name
#
# Usage:
#   ./scripts/generate-client-config "Device Name" [tailscale-auth-key]
#   ./scripts/generate-client-config "vless://uuid@host:port?..." [tailscale-auth-key]
#
# The Tailscale auth key can be passed as:
#   1. Second argument
#   2. TAILSCALE_AUTH_KEY environment variable
#   3. From .env file (lowest priority)
#

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# Save CLI-provided values before sourcing .env
CLI_TAILSCALE_AUTH_KEY="${TAILSCALE_AUTH_KEY:-}"

# Load environment (provides defaults)
if [[ -f "$PROJECT_DIR/.env" ]]; then
    source "$PROJECT_DIR/.env"
fi

# CLI/env overrides .env
if [[ -n "$CLI_TAILSCALE_AUTH_KEY" ]]; then
    TAILSCALE_AUTH_KEY="$CLI_TAILSCALE_AUTH_KEY"
fi

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# sing-box 1.13+ required for preferred_by Tailscale routing

usage() {
    echo "Usage: $0 <device-name|vless-url> [tailscale-auth-key]"
    echo ""
    echo "Examples:"
    echo "  $0 \"leo-mac\""
    echo "  $0 \"leo-mac\" \"tskey-auth-xxx\""
    echo "  $0 \"vless://uuid@host:port?...\""
    echo "  TAILSCALE_AUTH_KEY=tskey-xxx $0 \"leo-mac\""
    exit 1
}

[[ -z "$1" ]] && usage

INPUT="$1"

# Second argument overrides Tailscale auth key
if [[ -n "$2" ]]; then
    TAILSCALE_AUTH_KEY="$2"
fi

# Check if input is a VLESS URL or device name
if [[ "$INPUT" == vless://* ]]; then
    VLESS_URL="$INPUT"
else
    # Get URL from xray-users script
    VLESS_URL=$("$SCRIPT_DIR/xray-users" url "$INPUT" 2>/dev/null)
    if [[ -z "$VLESS_URL" ]]; then
        echo -e "${RED}Error: Could not get URL for device '$INPUT'${NC}"
        exit 1
    fi
fi

# Parse VLESS URL
# Format: vless://uuid@host:port?params#name
UUID=$(echo "$VLESS_URL" | sed -n 's|vless://\([^@]*\)@.*|\1|p')
HOST=$(echo "$VLESS_URL" | sed -n 's|vless://[^@]*@\([^:]*\):.*|\1|p')
PORT=$(echo "$VLESS_URL" | sed -n 's|vless://[^@]*@[^:]*:\([0-9]*\)?.*|\1|p')
SNI=$(echo "$VLESS_URL" | grep -oE 'sni=[^&]*' | cut -d= -f2)
PUBLIC_KEY=$(echo "$VLESS_URL" | grep -oE 'pbk=[^&]*' | cut -d= -f2)
SHORT_ID=$(echo "$VLESS_URL" | grep -oE 'sid=[^&]*' | cut -d= -f2)
NAME=$(echo "$VLESS_URL" | sed -n 's|.*#\(.*\)|\1|p')

# Validate parsed values
if [[ -z "$UUID" || -z "$HOST" || -z "$PUBLIC_KEY" || -z "$SHORT_ID" ]]; then
    echo -e "${RED}Error: Could not parse VLESS URL${NC}"
    echo "URL: $VLESS_URL"
    exit 1
fi

# Default values
PORT=${PORT:-443}
SNI=${SNI:-dl.google.com}
NAME=${NAME:-client}

echo -e "${GREEN}Generating config for: $NAME${NC}"
echo "  Server: $HOST:$PORT"
echo "  UUID: ${UUID:0:8}..."
echo "  SNI: $SNI"

# Generate Tailscale hostname from device name
# URL-decode NAME first (handle %40 -> @ etc)
DECODED_NAME=$(printf '%b' "${NAME//%/\\x}")
# Extract username part before @ if email, otherwise use full name
# Replace special chars with hyphens for valid hostname
if [[ "$DECODED_NAME" == *@* ]]; then
    TAILSCALE_HOSTNAME=$(echo "$DECODED_NAME" | sed 's/@.*//' | sed 's/[^a-zA-Z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')
else
    TAILSCALE_HOSTNAME=$(echo "$DECODED_NAME" | sed 's/[^a-zA-Z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')
fi
# Append -mac suffix for clarity
TAILSCALE_HOSTNAME="${TAILSCALE_HOSTNAME}-mac"

# Generate config using envsubst
export SERVER="$HOST"
export UUID
export SNI
export PUBLIC_KEY
export SHORT_ID
export HOME="$HOME"
export TAILSCALE_AUTH_KEY
export TAILSCALE_HOSTNAME

if [[ -z "$TAILSCALE_AUTH_KEY" ]]; then
    echo -e "${YELLOW}Warning: TAILSCALE_AUTH_KEY not set${NC}"
    echo "  Pass as second argument or set TAILSCALE_AUTH_KEY env var"
    echo "  Embedded Tailscale will require manual authentication"
else
    echo "  Tailscale hostname: $TAILSCALE_HOSTNAME"
fi

CONFIG=$(envsubst < "$PROJECT_DIR/config/client/sing-box.template.json")

# Output directory
OUTPUT_DIR="$PROJECT_DIR/config/client/generated"
PACKAGE_DIR="$OUTPUT_DIR/$NAME"
mkdir -p "$PACKAGE_DIR"

# Save config
CONFIG_FILE="$OUTPUT_DIR/${NAME}-config.json"
echo "$CONFIG" > "$CONFIG_FILE"
cp "$CONFIG_FILE" "$PACKAGE_DIR/config.json"
echo -e "${GREEN}Config saved to: $CONFIG_FILE${NC}"

# Validate config
SING_BOX_BIN="$PROJECT_DIR/local/bin/sing-box"
if [[ ! -x "$SING_BOX_BIN" ]]; then
    SING_BOX_BIN=$(command -v sing-box || echo "/usr/local/bin/sing-box")
fi
if [[ -x "$SING_BOX_BIN" ]]; then
    if "$SING_BOX_BIN" check -c "$CONFIG_FILE" 2>/dev/null; then
        echo -e "${GREEN}Config validated successfully${NC}"
    else
        echo -e "${YELLOW}Warning: Config validation failed${NC}"
    fi
fi

# Create VPN-Start.command
cat > "$PACKAGE_DIR/VPN-Start.command" << 'VPNSTART'
#!/bin/bash
cd "$(dirname "$0")"
echo "Starting XRay VPN..."
echo "Log file: ~/.config/sing-box/vpn.log"
echo "Press Ctrl+C to stop"
echo ""
sudo /usr/local/bin/sing-box run -c ~/.config/sing-box/config.json 2>&1 | tee ~/.config/sing-box/vpn.log
VPNSTART
chmod +x "$PACKAGE_DIR/VPN-Start.command"

# Create VPN-Stop.command
cat > "$PACKAGE_DIR/VPN-Stop.command" << 'VPNSTOP'
#!/bin/bash
echo "Stopping XRay VPN..."
sudo pkill sing-box
echo "VPN stopped."
sleep 2
VPNSTOP
chmod +x "$PACKAGE_DIR/VPN-Stop.command"

# Copy diagnose.sh from template
cp "$PROJECT_DIR/config/client/diagnose.template.sh" "$PACKAGE_DIR/diagnose.sh"
chmod +x "$PACKAGE_DIR/diagnose.sh"

# Create install.sh with correct VPN server IP
cat > "$PACKAGE_DIR/install.sh" << INSTALL
#!/bin/bash
#
# Automated VPN Installation Script for macOS
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

SCRIPT_DIR="\$(cd "\$(dirname "\$0")" && pwd)"
VPN_SERVER="$HOST"

echo -e "\${GREEN}=== XRay VPN Installer ===\${NC}"
echo ""

# Install sing-box
SING_BOX_VERSION="1.13.0-beta.8"
echo -e "\${GREEN}[1/5] Installing sing-box v\${SING_BOX_VERSION}...\${NC}"

CURRENT=\$(/usr/local/bin/sing-box version 2>/dev/null | grep -oE '[0-9]+\.[0-9]+\.[0-9]+(-beta\.[0-9]+)?' | head -1 || echo "none")
if [[ "\$CURRENT" == "\$SING_BOX_VERSION" ]]; then
    echo "sing-box \$SING_BOX_VERSION already installed"
else
    ARCH=\$(uname -m)
    [[ "\$ARCH" == "arm64" || "\$ARCH" == "aarch64" ]] && ARCH="arm64" || ARCH="amd64"
    
    echo "Downloading sing-box v\$SING_BOX_VERSION..."
    curl -sL "https://github.com/SagerNet/sing-box/releases/download/v\${SING_BOX_VERSION}/sing-box-\${SING_BOX_VERSION}-darwin-\${ARCH}.tar.gz" | tar -xz -C /tmp
    sudo mv "/tmp/sing-box-\${SING_BOX_VERSION}-darwin-\${ARCH}/sing-box" /usr/local/bin/
    sudo chmod +x /usr/local/bin/sing-box
    rm -rf "/tmp/sing-box-\${SING_BOX_VERSION}-darwin-\${ARCH}"
    echo -e "\${GREEN}sing-box v\$SING_BOX_VERSION installed\${NC}"
fi

# Install config
echo -e "\${GREEN}[2/5] Installing config...\${NC}"
mkdir -p ~/.config/sing-box
mkdir -p ~/.local/share/sing-box-tailscale
cp "\$SCRIPT_DIR/config.json" ~/.config/sing-box/
echo "Config installed to ~/.config/sing-box/config.json"
echo "Tailscale state directory: ~/.local/share/sing-box-tailscale/"

# Validate config
if /usr/local/bin/sing-box check -c ~/.config/sing-box/config.json 2>/dev/null; then
    echo -e "\${GREEN}Config validated successfully\${NC}"
else
    echo -e "\${YELLOW}Warning: Config validation failed\${NC}"
fi

# Validate config
echo -e "\${GREEN}[3/5] Validating config...\${NC}"
if sing-box check -c ~/.config/sing-box/config.json 2>/dev/null; then
    echo -e "\${GREEN}Config validated successfully\${NC}"
else
    echo -e "\${YELLOW}Warning: Config validation failed\${NC}"
fi

# Install shortcuts
echo -e "\${GREEN}[4/5] Installing shortcuts...\${NC}"
cp "\$SCRIPT_DIR/VPN-Start.command" ~/
cp "\$SCRIPT_DIR/VPN-Stop.command" ~/
chmod +x ~/VPN-Start.command ~/VPN-Stop.command
echo "Shortcuts installed to home folder"

# Install diagnose script
echo -e "\${GREEN}[5/5] Installing diagnose script...\${NC}"
cp "\$SCRIPT_DIR/diagnose.sh" ~/.config/sing-box/
chmod +x ~/.config/sing-box/diagnose.sh
echo "Diagnose script installed to ~/.config/sing-box/diagnose.sh"

echo ""
echo -e "\${GREEN}=== Installation Complete ===\${NC}"
echo ""
echo "To start VPN:"
echo "  Double-click ~/VPN-Start.command"
echo "  Or run: ~/VPN-Start.command"
echo ""
echo "To stop VPN:"
echo "  Double-click ~/VPN-Stop.command"
echo "  Or press Ctrl+C in the terminal"
echo ""
echo "To verify VPN is working:"
echo "  curl ifconfig.me"
echo "  # Should show: \$VPN_SERVER"
echo ""
echo "To run diagnostics:"
echo "  ~/.config/sing-box/diagnose.sh"
echo ""
echo -e "\${YELLOW}IMPORTANT: Quit Tailscale.app before starting VPN (embedded Tailscale conflicts with standalone app)\${NC}"
echo ""
echo -e "\${GREEN}NOTE: Corporate domains resolved via internal DNS (<INTERNAL_DNS_1>) through embedded Tailscale\${NC}"
echo -e "\${GREEN}      Wait ~15 seconds after startup for Tailscale to initialize before testing DNS\${NC}"
INSTALL
chmod +x "$PACKAGE_DIR/install.sh"

# Create README.md
cat > "$PACKAGE_DIR/README.md" << README
# XRay VPN Setup for $NAME

## Prerequisites

- macOS (Apple Silicon or Intel)
- Administrator access (for sudo)
- **Stop Tailscale app before starting VPN** (embedded Tailscale conflicts with standalone app)

## Before First Run

If you have Tailscale.app installed, quit it before starting the VPN:

\`\`\`bash
# Quit Tailscale app
osascript -e 'quit app "Tailscale"'
\`\`\`

Or right-click the Tailscale icon in menu bar → Quit Tailscale.

## Quick Install

Run the installer:

\`\`\`bash
cd $NAME
./install.sh
\`\`\`

## Manual Installation

### 1. Install sing-box via Homebrew

\`\`\`bash
brew install sing-box
\`\`\`

### 2. Install config

\`\`\`bash
mkdir -p ~/.config/sing-box
mkdir -p ~/.local/share/sing-box-tailscale
cp config.json ~/.config/sing-box/
\`\`\`

### 3. Install shortcuts

\`\`\`bash
cp VPN-Start.command VPN-Stop.command ~/
chmod +x ~/VPN-Start.command ~/VPN-Stop.command
\`\`\`

## Usage

### Start VPN
Double-click \`VPN-Start.command\` in your home folder (or run \`~/VPN-Start.command\` in Terminal).

Enter your Mac password when prompted.

### Stop VPN
Double-click \`VPN-Stop.command\` or press \`Ctrl+C\` in the Terminal window.

### Verify VPN is working
\`\`\`bash
curl ifconfig.me
# Should show: $HOST
\`\`\`

### Run diagnostics
\`\`\`bash
~/.config/sing-box/diagnose.sh
\`\`\`

## Embedded Tailscale

This VPN includes embedded Tailscale for corporate network access:

- **DNS Resolution:** Corporate domains (.<COMPANY_DOMAIN>) resolved via internal DNS servers (<INTERNAL_DNS_1>)
- **Routing:** Traffic to Tailscale-advertised IPs routed automatically via \`preferred_by\` rule
- **Startup Delay:** Tailscale needs ~15 seconds after VPN start to get IPv4 assigned
- **Auth:** Automatic authentication using pre-configured auth key

**Important Notes:**
1. **Quit Tailscale.app** before starting VPN (embedded Tailscale conflicts with standalone app)
2. **Wait 15 seconds** after startup before testing corporate domain access
3. If DNS fails with "missing Tailscale IPv4 address", wait for Tailscale to initialize

**DNS Architecture:**
- \`.ts.net\` domains → Native Tailscale MagicDNS
- \`.<COMPANY_DOMAIN>\` → Internal DNS (<INTERNAL_DNS_1>) via Tailscale routing

## Troubleshooting

### "Operation not permitted" error
Make sure the .command files are executable:
\`\`\`bash
chmod +x ~/VPN-Start.command ~/VPN-Stop.command
\`\`\`

### VPN connects but no internet
Try restarting:
\`\`\`bash
sudo pkill sing-box
~/VPN-Start.command
\`\`\`

### Check VPN logs
\`\`\`bash
cat ~/.config/sing-box/vpn.log
\`\`\`

## Files Included

| File | Description |
|------|-------------|
| \`config.json\` | sing-box configuration |
| \`VPN-Start.command\` | Double-click to start VPN |
| \`VPN-Stop.command\` | Double-click to stop VPN |
| \`diagnose.sh\` | Run diagnostics if VPN not working |
| \`install.sh\` | Automated installer |
| \`README.md\` | This file |
README

# Create ZIP file
ZIP_FILE="$OUTPUT_DIR/${NAME}-vpn.zip"
cd "$OUTPUT_DIR"
rm -f "${NAME}-vpn.zip"
zip -r "${NAME}-vpn.zip" "$NAME"
echo ""
echo -e "${GREEN}Package created: $ZIP_FILE${NC}"

# List package contents
echo ""
echo "Package contents:"
ls -la "$PACKAGE_DIR"

echo ""
echo -e "${YELLOW}To install on client:${NC}"
echo "  1. Transfer $ZIP_FILE to the client"
echo "  2. Unzip and run: ./$NAME/install.sh"
